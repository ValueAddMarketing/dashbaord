<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAM Client Success Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#030712', 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        brand: { cyan: '#06b6d4', purple: '#8b5cf6', blue: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #030712; color: #f1f5f9; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .card { background: #0f172a; border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; }
        .card:hover { border-color: rgba(6, 182, 212, 0.3); }
        .gradient-border { background: linear-gradient(135deg, #06b6d4, #8b5cf6); padding: 1px; border-radius: 16px; }
        .gradient-border > div { background: #0f172a; border-radius: 15px; }
        .progress-ring { transform: rotate(-90deg); }
        .tab-active { background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(139,92,246,0.15)); border-bottom: 2px solid #06b6d4; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; }
        .timeline-line { width: 2px; background: linear-gradient(to bottom, #06b6d4, #8b5cf6); }
        .scrollbar::-webkit-scrollbar { width: 4px; }
        .scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .health-ring { stroke-dasharray: 251.2; stroke-dashoffset: 251.2; transition: stroke-dashoffset 1s ease-out; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext } = React;

        // Supabase
        const SUPABASE_URL = 'https://ecmhhonjazfbletyvncw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWhob25qYXpmYmxldHl2bmN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDMwMjYsImV4cCI6MjA4MTUxOTAyNn0.3LZ8dAOX_ZpoUNkgY_jSeC10SaCknfPfBaZsDRjFt7c';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const AuthContext = createContext(null);
        const useAuth = () => useContext(AuthContext);

        const URLS = {
            clients: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRimOKUGksj-OVBSCpb9UGnkQU3Wu547GpcaUk4RT0oo5KM0fnVo2sk8mRpy4cwO5j9CckDORzmou-d/pub?gid=133498635&single=true&output=csv',
            setupTiming: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4LTw-15NE0j25eIOpY_bTPSAipW7-F2eXnL0xtdXMWCZtK9z3MYWxHr6ltnMChLk-YDLzwiXAfvwE/pub?gid=646836237&single=true&output=csv'
        };

        // Utilities
        const pn = v => parseFloat(String(v||'0').replace(/[$,%]/g,'').replace(/,/g,''))||0;
        const fmt = v => '$'+(pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const fmtD = v => '$'+(pn(v)).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        const fmtN = v => (pn(v)).toLocaleString('en-US',{maximumFractionDigits:0});
        const clean = v => (v && v.toString().trim()) ? v.toString().trim() : '‚Äî';
        const getDisplayName = (email) => email ? email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Unknown';

        // Data Mappers
        const mapClient = r => ({
            client: r['Client']||'', adAccount: r['Ad Account Name']||'', state: r['State']||'', 
            campaign: r['CAMPAIGN']||'', days: pn(r['Days Running']), weeks: pn(r['Weeks Running']),
            spend: pn(r['Total Ad Spend']), dailyBudget: pn(r['Daily Ad Spend Budget']), spendPerDay: pn(r['Ad Spend Per Day']),
            leads: pn(r['Total Leads']), cpl: pn(r['Cost Per Lead']),
            sellerLeads: pn(r['Seller Leads']), buyerLeads: pn(r['Buyer Leads']),
            appts: pn(r['Total Appts']), apptsWeek: pn(r['Appt per Week']), appts7: pn(r['Appts in the Last 7 Days']),
            deals: pn(r['Potential Deals']), listings: pn(r['Listing']), buyerSigned: pn(r['Buyer Signed'])
        });

        const mapSetupTiming = r => ({
            client: r['VAM'] || '', csmRep: r['CSM'] || '', status: r['Status'] || '', concern: r['Concern'] || '',
            state: r['State'] || '', campaign: r['Campaign'] || '', contractCategory: r['Contract Category'] || '',
            mrr: r['MRR'] || '', fulfilled: r['Fullfilled'] || '', daysLeft: r['Days left'] || '',
            duePayment: r['Due Payment'] || '', paidDate: r['Paid date'] || '', onboardedDate: r['Onboarded date'] || '',
            launchCallDate: r['Launch call date'] || '', adLiveDate: r[' Ad Live date'] || r['Ad Live date'] || '',
            closings: r['Closings'] || '', signed: r['Signed'] || '', redFlags: r['Red flags'] || '',
            unresolvedConcerns: r['Unresolved Concerns'] || '', personality: r['Personality'] || '',
            expectations: r['Expectations'] || '', revenueContracted: r['Revenue Contracted'] || '',
            contractLength: r['Contract length'] || '', calling: r['Calling'] || '', dialer: r['Dialer'] || '',
        });

        // Health Calculations
        const getHealthScore = (c, s) => {
            if (!c) return 0;
            let score = 50;
            // CPL scoring (0-25 points)
            if (c.cpl <= 15) score += 25;
            else if (c.cpl <= 25) score += 20;
            else if (c.cpl <= 35) score += 10;
            else if (c.cpl <= 50) score += 5;
            // Appointments (0-15 points)
            if (c.appts7 >= 5) score += 15;
            else if (c.appts7 >= 3) score += 10;
            else if (c.appts7 >= 1) score += 5;
            // Deals/Listings (0-10 points)
            if (c.deals > 0 || c.listings > 0) score += 10;
            // Deductions
            if (s?.duePayment?.includes('OVERDUE')) score -= 15;
            if (s?.redFlags) score -= 10;
            if (s?.unresolvedConcerns) score -= 5;
            return Math.max(0, Math.min(100, score));
        };

        const getHealthColor = (score) => {
            if (score >= 80) return { bg: 'bg-emerald-500', text: 'text-emerald-400', stroke: '#10b981' };
            if (score >= 60) return { bg: 'bg-amber-500', text: 'text-amber-400', stroke: '#f59e0b' };
            return { bg: 'bg-red-500', text: 'text-red-400', stroke: '#ef4444' };
        };

        const getPhase = (days) => {
            if (days <= 14) return { phase: 1, name: 'Onboarding', color: 'cyan', progress: Math.min(100, (days / 14) * 100) };
            if (days <= 30) return { phase: 2, name: 'Optimization', color: 'blue', progress: Math.min(100, ((days - 14) / 16) * 100) };
            if (days <= 60) return { phase: 3, name: 'Scaling', color: 'purple', progress: Math.min(100, ((days - 30) / 30) * 100) };
            return { phase: 4, name: 'Systemization', color: 'emerald', progress: 100 };
        };

        // ========== LOGIN ==========
        const LoginPage = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const result = await supabase.auth.signInWithPassword({ email, password });
                    if (result.error) throw result.error;
                    onLogin(result.data.user);
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                            <p className="text-slate-500 mt-2">Sign in to continue</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-cyan" placeholder="Email" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-dark-800 border border-dark-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-cyan" placeholder="Password" required />
                            {error && <div className="p-3 rounded-xl bg-red-500/10 text-red-400 text-sm">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-brand-cyan to-brand-purple text-white font-semibold rounded-xl hover:opacity-90 disabled:opacity-50">
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // ========== HEALTH SCORE RING ==========
        const HealthRing = ({ score, size = 120 }) => {
            const color = getHealthColor(score);
            const circumference = 2 * Math.PI * 40;
            const offset = circumference - (score / 100) * circumference;
            
            return (
                <div className="relative" style={{ width: size, height: size }}>
                    <svg className="progress-ring" width={size} height={size}>
                        <circle cx={size/2} cy={size/2} r="40" fill="none" stroke="#1e293b" strokeWidth="8" />
                        <circle cx={size/2} cy={size/2} r="40" fill="none" stroke={color.stroke} strokeWidth="8" strokeLinecap="round" style={{ strokeDasharray: circumference, strokeDashoffset: offset, transition: 'stroke-dashoffset 1s ease-out' }} />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className={`text-3xl font-bold ${color.text}`}>{score}</span>
                        <span className="text-xs text-slate-500">Health</span>
                    </div>
                </div>
            );
        };

        // ========== 90 DAY JOURNEY ==========
        const JourneyTimeline = ({ c, s }) => {
            const phase = getPhase(c?.days || 0);
            const milestones = [
                { day: 0, name: 'Paid', icon: 'üí∞', date: s?.paidDate, completed: !!s?.paidDate },
                { day: 3, name: 'Onboarded', icon: 'üöÄ', date: s?.onboardedDate, completed: !!s?.onboardedDate },
                { day: 7, name: 'Launch Call', icon: 'üìû', date: s?.launchCallDate, completed: !!s?.launchCallDate },
                { day: 14, name: 'Ads Live', icon: 'üì¢', date: s?.adLiveDate, completed: !!s?.adLiveDate },
                { day: 30, name: '1st Appt', icon: 'üìÖ', completed: c?.appts > 0 },
                { day: 60, name: '1st Deal', icon: 'üè†', completed: c?.deals > 0 || c?.listings > 0 },
                { day: 90, name: 'ROI Goal', icon: 'üéØ', completed: false },
            ];

            return (
                <div className="card p-6">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="text-lg font-semibold text-white">90-Day Journey</h3>
                        <div className={`px-3 py-1 rounded-full text-sm font-medium bg-${phase.color}-500/20 text-${phase.color}-400`}>
                            Phase {phase.phase}: {phase.name}
                        </div>
                    </div>
                    
                    {/* Progress Bar */}
                    <div className="relative mb-8">
                        <div className="h-2 bg-dark-800 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-brand-cyan to-brand-purple rounded-full transition-all duration-1000" style={{ width: `${Math.min(100, (c?.days || 0) / 90 * 100)}%` }} />
                        </div>
                        <div className="flex justify-between mt-2 text-xs text-slate-500">
                            <span>Day 1</span>
                            <span>Day 30</span>
                            <span>Day 60</span>
                            <span>Day 90</span>
                        </div>
                    </div>

                    {/* Milestones */}
                    <div className="grid grid-cols-7 gap-2">
                        {milestones.map((m, i) => (
                            <div key={i} className="text-center">
                                <div className={`w-10 h-10 mx-auto rounded-xl flex items-center justify-center text-lg ${m.completed ? 'bg-emerald-500/20' : 'bg-dark-800'}`}>
                                    {m.completed ? '‚úì' : m.icon}
                                </div>
                                <div className="mt-2 text-xs text-slate-400">{m.name}</div>
                                {m.date && <div className="text-xs text-slate-600">{m.date}</div>}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== METRICS GRID ==========
        const MetricCard = ({ label, value, subvalue, trend, icon }) => (
            <div className="card p-4">
                <div className="flex items-center justify-between mb-2">
                    <span className="text-slate-500 text-sm">{label}</span>
                    <span className="text-lg">{icon}</span>
                </div>
                <div className="text-2xl font-bold text-white">{value}</div>
                {subvalue && <div className="text-sm text-slate-500 mt-1">{subvalue}</div>}
                {trend && <div className={`text-xs mt-1 ${trend > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{trend > 0 ? '‚Üë' : '‚Üì'} {Math.abs(trend)}%</div>}
            </div>
        );

        // ========== MEETING NOTES ==========
        const MeetingNotesSection = ({ c }) => {
            const { user } = useAuth();
            const [meetings, setMeetings] = useState([]);
            const [transcript, setTranscript] = useState('');
            const [processing, setProcessing] = useState(false);
            const [summary, setSummary] = useState(null);
            const [showInput, setShowInput] = useState(false);

            useEffect(() => { if (c?.client) loadMeetings(); }, [c?.client]);

            const loadMeetings = async () => {
                const { data } = await supabase.from('meeting_notes').select('*').eq('client_name', c.client).order('meeting_date', { ascending: false }).limit(5);
                if (data) setMeetings(data);
            };

            const processTranscript = async () => {
                setProcessing(true);
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1500,
                            messages: [{ role: 'user', content: `Summarize this meeting for ${c?.client}. Return JSON with: summary, clientSentiment (positive/neutral/negative), keyPoints (array), actionItems (array of {task, owner, priority}), concerns (array), wins (array), riskLevel (low/medium/high), nextSteps.\n\nTranscript:\n${transcript}` }]
                        })
                    });
                    const data = await response.json();
                    setSummary(JSON.parse(data.content?.[0]?.text || '{}'));
                } catch (err) {
                    setSummary({ summary: "Transcript saved for manual review.", keyPoints: [], actionItems: [], riskLevel: "medium" });
                }
                setProcessing(false);
            };

            const saveMeeting = async () => {
                if (!summary) return;
                const { data } = await supabase.from('meeting_notes').insert({
                    client_name: c.client, meeting_date: new Date().toISOString().split('T')[0],
                    transcript, summary: summary.summary, client_sentiment: summary.clientSentiment,
                    key_points: summary.keyPoints, action_items: summary.actionItems,
                    risk_level: summary.riskLevel, next_steps: summary.nextSteps,
                    user_id: user?.id, user_email: user?.email
                }).select().single();
                if (data) { setMeetings([data, ...meetings]); setTranscript(''); setSummary(null); setShowInput(false); }
            };

            const sentimentColors = { positive: 'text-emerald-400', neutral: 'text-slate-400', negative: 'text-red-400' };
            const riskColors = { low: 'bg-emerald-500/20 text-emerald-400', medium: 'bg-amber-500/20 text-amber-400', high: 'bg-red-500/20 text-red-400' };

            return (
                <div className="card p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-semibold text-white">üìù Meeting Notes</h3>
                        <button onClick={() => setShowInput(!showInput)} className="px-4 py-2 bg-brand-cyan/20 text-brand-cyan rounded-lg text-sm hover:bg-brand-cyan/30">
                            {showInput ? 'Cancel' : '+ Add Meeting'}
                        </button>
                    </div>

                    {showInput && (
                        <div className="mb-6 p-4 bg-dark-800 rounded-xl">
                            <textarea value={transcript} onChange={e => setTranscript(e.target.value)} placeholder="Paste meeting transcript..." className="w-full bg-dark-900 border border-dark-700 rounded-lg p-3 text-white min-h-[120px] focus:outline-none focus:border-brand-cyan" />
                            <div className="flex gap-2 mt-3">
                                <button onClick={processTranscript} disabled={!transcript.trim() || processing} className="px-4 py-2 bg-gradient-to-r from-brand-cyan to-brand-purple text-white rounded-lg text-sm disabled:opacity-50">
                                    {processing ? 'ü§ñ Analyzing...' : 'ü§ñ Analyze with AI'}
                                </button>
                                {summary && <button onClick={saveMeeting} className="px-4 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg text-sm">üíæ Save</button>}
                            </div>
                            {summary && (
                                <div className="mt-4 p-4 bg-dark-900 rounded-lg">
                                    <p className="text-slate-300 text-sm">{summary.summary}</p>
                                    {summary.actionItems?.length > 0 && (
                                        <div className="mt-3">
                                            <div className="text-xs text-slate-500 mb-1">Action Items:</div>
                                            {summary.actionItems.map((a, i) => <div key={i} className="text-sm text-slate-400">‚Ä¢ {a.task} ({a.owner})</div>)}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Recent Meetings */}
                    <div className="space-y-3">
                        {meetings.length === 0 ? (
                            <div className="text-center py-8 text-slate-500">No meetings recorded yet</div>
                        ) : meetings.map(m => (
                            <div key={m.id} className="p-4 bg-dark-800 rounded-xl">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className="text-white font-medium">{new Date(m.meeting_date).toLocaleDateString()}</span>
                                        <span className={`text-xs ${sentimentColors[m.client_sentiment]}`}>{m.client_sentiment}</span>
                                    </div>
                                    <span className={`px-2 py-1 rounded text-xs ${riskColors[m.risk_level]}`}>{m.risk_level} risk</span>
                                </div>
                                <p className="text-slate-400 text-sm">{m.summary}</p>
                                {m.action_items?.length > 0 && (
                                    <div className="mt-2 flex flex-wrap gap-1">
                                        {m.action_items.slice(0, 3).map((a, i) => (
                                            <span key={i} className="px-2 py-1 bg-dark-700 rounded text-xs text-slate-400">{a.task}</span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== ACTION ITEMS ==========
        const ActionItems = ({ c }) => {
            const { user } = useAuth();
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState('');

            useEffect(() => { if (c?.client) loadItems(); }, [c?.client]);

            const loadItems = async () => {
                const { data } = await supabase.from('client_notes').select('*').eq('client_name', c.client).order('created_at', { ascending: false }).limit(10);
                if (data) setItems(data);
            };

            const addItem = async () => {
                if (!newItem.trim()) return;
                const { data } = await supabase.from('client_notes').insert({
                    client_name: c.client, note_text: newItem, user_email: user?.email, user_id: user?.id
                }).select().single();
                if (data) { setItems([data, ...items]); setNewItem(''); }
            };

            const deleteItem = async (id) => {
                await supabase.from('client_notes').delete().eq('id', id);
                setItems(items.filter(i => i.id !== id));
            };

            return (
                <div className="card p-6">
                    <h3 className="text-lg font-semibold text-white mb-4">‚úÖ Action Items & Notes</h3>
                    <div className="flex gap-2 mb-4">
                        <input value={newItem} onChange={e => setNewItem(e.target.value)} onKeyPress={e => e.key === 'Enter' && addItem()} placeholder="Add action item or note..." className="flex-1 bg-dark-800 border border-dark-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-brand-cyan" />
                        <button onClick={addItem} className="px-4 py-2 bg-brand-cyan text-dark-900 font-medium rounded-lg text-sm">Add</button>
                    </div>
                    <div className="space-y-2 max-h-64 overflow-y-auto scrollbar">
                        {items.map(i => (
                            <div key={i.id} className="flex items-center gap-3 p-3 bg-dark-800 rounded-lg group">
                                <div className="flex-1">
                                    <div className="text-sm text-white">{i.note_text}</div>
                                    <div className="text-xs text-slate-500">{getDisplayName(i.user_email)} ‚Ä¢ {new Date(i.created_at).toLocaleDateString()}</div>
                                </div>
                                <button onClick={() => deleteItem(i.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100">‚úï</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ========== ALERTS SECTION ==========
        const AlertsSection = ({ c, s }) => {
            const alerts = [];
            if (s?.duePayment?.includes('OVERDUE')) alerts.push({ type: 'error', icon: 'üí≥', text: 'Payment Overdue' });
            if (s?.redFlags) alerts.push({ type: 'error', icon: 'üö©', text: `Red Flag: ${s.redFlags}` });
            if (s?.unresolvedConcerns) alerts.push({ type: 'warning', icon: '‚ö†Ô∏è', text: s.unresolvedConcerns });
            if (c?.cpl > 50) alerts.push({ type: 'warning', icon: 'üìà', text: `High CPL: ${fmtD(c.cpl)}` });
            if (c?.appts7 === 0 && c?.days > 14) alerts.push({ type: 'warning', icon: 'üìÖ', text: 'No appointments this week' });

            if (alerts.length === 0) return null;

            return (
                <div className="space-y-2 mb-6">
                    {alerts.map((a, i) => (
                        <div key={i} className={`p-4 rounded-xl flex items-center gap-3 ${a.type === 'error' ? 'bg-red-500/10 border border-red-500/20' : 'bg-amber-500/10 border border-amber-500/20'}`}>
                            <span className="text-xl">{a.icon}</span>
                            <span className={a.type === 'error' ? 'text-red-400' : 'text-amber-400'}>{a.text}</span>
                        </div>
                    ))}
                </div>
            );
        };

        // ========== CLIENT DETAILS ==========
        const ClientDetails = ({ c, s }) => (
            <div className="card p-6">
                <h3 className="text-lg font-semibold text-white mb-4">üìã Client Details</h3>
                <div className="grid grid-cols-2 gap-4 text-sm">
                    <div><span className="text-slate-500">CSM:</span> <span className="text-white ml-2">{s?.csmRep || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">State:</span> <span className="text-white ml-2">{s?.state || c?.state || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">Campaign:</span> <span className="text-white ml-2">{s?.campaign || c?.campaign || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">Contract:</span> <span className="text-white ml-2">{s?.contractCategory || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">MRR:</span> <span className="text-emerald-400 ml-2">{s?.mrr || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">Days Left:</span> <span className={`ml-2 ${pn(s?.daysLeft) < 0 ? 'text-red-400' : 'text-white'}`}>{s?.daysLeft || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">Calling:</span> <span className="text-white ml-2">{s?.calling || '‚Äî'}</span></div>
                    <div><span className="text-slate-500">Dialer:</span> <span className="text-white ml-2">{s?.dialer || '‚Äî'}</span></div>
                </div>
            </div>
        );

        // ========== MAIN APP ==========
        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [clients, setClients] = useState([]);
            const [setupData, setSetupData] = useState([]);
            const [selected, setSelected] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user || null);
                    setAuthLoading(false);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setUser(session?.user || null));
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const params = new URLSearchParams(window.location.search);
                const clientParam = params.get('client');
                Promise.all([
                    fetch(URLS.clients).then(r => r.text()).then(csv => Papa.parse(csv.split('\n').slice(2).join('\n'), { header: true, skipEmptyLines: true }).data.map(mapClient).filter(r => r.client)),
                    fetch(URLS.setupTiming).then(r => r.text()).then(csv => { const lines = csv.split('\n'); return Papa.parse([lines[0], ...lines.slice(2)].join('\n'), { header: true, skipEmptyLines: true }).data.map(mapSetupTiming).filter(r => r.client); })
                ]).then(([c, s]) => {
                    setClients(c); setSetupData(s);
                    if (clientParam) { const found = c.find(x => x.client.toLowerCase() === decodeURIComponent(clientParam).toLowerCase()); if (found) setSelected(found); }
                    setLoading(false);
                });
            }, [user]);

            const handleLogout = () => supabase.auth.signOut();

            const getSetupInfo = (client) => {
                if (!client) return null;
                const name = client.client.toLowerCase().trim();
                return setupData.find(s => { const sn = (s.client || '').toLowerCase().trim(); return sn === name || sn.includes(name) || name.includes(sn); });
            };

            if (authLoading || loading) return <div className="min-h-screen flex items-center justify-center text-4xl">‚è≥</div>;
            if (!user) return <LoginPage onLogin={setUser} />;

            const s = getSetupInfo(selected);
            const healthScore = getHealthScore(selected, s);
            const healthColor = getHealthColor(healthScore);

            return (
                <AuthContext.Provider value={{ user }}>
                    <div className="min-h-screen">
                        {/* Header */}
                        <header className="glass sticky top-0 z-50 border-b border-white/5">
                            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                                <div className="flex items-center gap-6">
                                    <h1 className="text-xl font-bold bg-gradient-to-r from-brand-cyan to-brand-purple bg-clip-text text-transparent">VAM Client Success Hub</h1>
                                    <select value={selected?.client || ''} onChange={e => setSelected(clients.find(c => c.client === e.target.value))} className="bg-dark-800 border border-dark-700 rounded-xl px-4 py-2 text-white text-sm focus:outline-none focus:border-brand-cyan min-w-[250px]">
                                        <option value="">Select a client...</option>
                                        {clients.map(c => <option key={c.client} value={c.client}>{c.client}</option>)}
                                    </select>
                                </div>
                                <div className="flex items-center gap-4">
                                    <a href="dashboard.html" className="px-4 py-2 bg-dark-800 hover:bg-dark-700 text-slate-300 rounded-lg text-sm">Media Buyer Overview</a>
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                        <span className="text-sm text-slate-400">{getDisplayName(user.email)}</span>
                                    </div>
                                    <button onClick={handleLogout} className="text-slate-500 hover:text-red-400 text-sm">Logout</button>
                                </div>
                            </div>
                        </header>

                        {/* Main Content */}
                        {!selected ? (
                            <div className="max-w-7xl mx-auto px-6 py-20 text-center">
                                <div className="text-6xl mb-4">üëÜ</div>
                                <h2 className="text-2xl font-semibold text-white mb-2">Select a Client</h2>
                                <p className="text-slate-500">Choose a client from the dropdown to view their success hub</p>
                            </div>
                        ) : (
                            <main className="max-w-7xl mx-auto px-6 py-8">
                                {/* Client Header */}
                                <div className="flex items-start gap-6 mb-8">
                                    <HealthRing score={healthScore} />
                                    <div className="flex-1">
                                        <div className="flex items-center gap-4 mb-2">
                                            <h2 className="text-3xl font-bold text-white">{selected.client}</h2>
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${healthColor.bg}/20 ${healthColor.text}`}>
                                                {healthScore >= 80 ? 'Healthy' : healthScore >= 60 ? 'Needs Attention' : 'At Risk'}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-4 text-slate-400 text-sm">
                                            <span>Day {selected.days}</span>
                                            <span>‚Ä¢</span>
                                            <span>CSM: {s?.csmRep || 'Unassigned'}</span>
                                            <span>‚Ä¢</span>
                                            <span className="text-emerald-400">{s?.mrr || '‚Äî'} MRR</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Alerts */}
                                <AlertsSection c={selected} s={s} />

                                {/* 90 Day Journey */}
                                <div className="mb-8">
                                    <JourneyTimeline c={selected} s={s} />
                                </div>

                                {/* Metrics Grid */}
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                                    <MetricCard label="Total Spend" value={fmt(selected.spend)} icon="üí∞" />
                                    <MetricCard label="Total Leads" value={fmtN(selected.leads)} icon="üë•" />
                                    <MetricCard label="CPL" value={fmtD(selected.cpl)} icon="üìä" />
                                    <MetricCard label="Appointments" value={fmtN(selected.appts)} subvalue={`${selected.appts7} this week`} icon="üìÖ" />
                                    <MetricCard label="Deals" value={fmtN(selected.deals)} icon="üè†" />
                                    <MetricCard label="Listings" value={fmtN(selected.listings)} icon="üìã" />
                                </div>

                                {/* Main Grid */}
                                <div className="grid lg:grid-cols-2 gap-6">
                                    <MeetingNotesSection c={selected} />
                                    <div className="space-y-6">
                                        <ActionItems c={selected} />
                                        <ClientDetails c={selected} s={s} />
                                    </div>
                                </div>
                            </main>
                        )}
                    </div>
                </AuthContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
